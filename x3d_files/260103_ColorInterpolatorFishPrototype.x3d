<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE X3D PUBLIC "ISO//Web3D//DTD X3D 3.3//EN"
  "https://www.web3d.org/specifications/x3d-3.3.dtd">

<X3D profile="Immersive" version="3.3"
     xmlns:xsd="http://www.w3.org/2001/XMLSchema-instance"
     xsd:noNamespaceSchemaLocation="https://www.web3d.org/specifications/x3d-3.3.xsd">

<head>
  <meta name="title" content="CircleFish Improved Prototype"/>
  <meta name="description"
        content="Angelfish-like flat diamond fish with smooth head shape and vivid color animation"/>
  <meta name="creator" content="ChatGPT"/>
</head>

<Scene>

  <!-- ================= Prototype ================= -->
  <ProtoDeclare name="CircleFish">

    <ProtoInterface>
      <field name="scale" type="SFVec3f" accessType="inputOutput" value="1 1 1"/>
      <field name="baseColor" type="SFColor" accessType="inputOutput" value="0.1 0.4 0.9"/>
    </ProtoInterface>

    <ProtoBody>

      <Transform>
        <IS>
          <connect nodeField="scale" protoField="scale"/>
        </IS>

        <!-- ================= Animation ================= -->
        <TimeSensor DEF="ColorClock" cycleInterval="6" loop="true"/>

        <ColorInterpolator DEF="ColorAnim"
          key="0 0.33 0.66 1"
          keyValue="
            0.1 0.4 0.9
            0.0 0.8 0.7
            0.6 0.2 0.8
            0.1 0.4 0.9"/>

        <!-- ================= Body ================= -->
        <Shape>
          <Appearance>
            <Material DEF="BodyMaterial">
              <IS>
                <connect nodeField="diffuseColor" protoField="baseColor"/>
              </IS>
            </Material>
          </Appearance>

          <!-- Smooth angelfish body -->
          <Extrusion
            crossSection="
              0 0.5,
              0.035 0.35,
              0.05 0,
              0.035 -0.35,
              0 -0.5,
              -0.035 -0.35,
              -0.05 0,
              -0.035 0.35,
              0 0.5"
            spine="
              0 0 0,
              0 0.3 0,
              0 0.7 0,
              0 1 0"
            scale="
              0.2 0.2,
              1 1,
              1 1,
              0.15 0.15"
            solid="true"
            convex="true"/>
        </Shape>

        <!-- ================= Eyes ================= -->
        <Transform translation="0.04 0.2 0.05">
          <Shape>
            <Appearance>
              <Material diffuseColor="0 0 0"/>
            </Appearance>
            <Sphere radius="0.02"/>
          </Shape>
        </Transform>

        <Transform translation="-0.04 0.2 0.05">
          <Shape>
            <Appearance>
              <Material diffuseColor="0 0 0"/>
            </Appearance>
            <Sphere radius="0.02"/>
          </Shape>
        </Transform>

        <!-- ================= Top Fin ================= -->
        <Transform translation="0 0.55 0.05">
          <Shape>
            <Appearance>
              <Material diffuseColor="0.4 0.6 1"/>
            </Appearance>
            <IndexedFaceSet coordIndex="0 1 2 -1">
              <Coordinate point="
                0 0 0,
                0.12 0.35 0,
                -0.12 0.35 0"/>
            </IndexedFaceSet>
          </Shape>
        </Transform>

        <!-- ================= Bottom Fin ================= -->
        <Transform translation="0 0.35 -0.05">
          <Shape>
            <Appearance>
              <Material diffuseColor="0.4 0.6 1"/>
            </Appearance>
            <IndexedFaceSet coordIndex="0 1 2 -1">
              <Coordinate point="
                0 0 0,
                0.12 -0.35 0,
                -0.12 -0.35 0"/>
            </IndexedFaceSet>
          </Shape>
        </Transform>

        <!-- ================= Tail Fin ================= -->
        <Transform translation="0 1 0">
          <Shape>
            <Appearance>
              <Material diffuseColor="0.6 0.8 1"/>
            </Appearance>
            <IndexedFaceSet coordIndex="0 1 2 -1">
              <Coordinate point="
                0 0 0,
                0.18 0.25 0,
                -0.18 0.25 0"/>
            </IndexedFaceSet>
          </Shape>
        </Transform>

        <!-- ================= ROUTES ================= -->
        <ROUTE fromNode="ColorClock" fromField="fraction_changed"
               toNode="ColorAnim" toField="set_fraction"/>

        <ROUTE fromNode="ColorAnim" fromField="value_changed"
               toNode="BodyMaterial" toField="diffuseColor"/>

      </Transform>

    </ProtoBody>
  </ProtoDeclare>

  <!-- ================= Instance ================= -->
  <ProtoInstance name="CircleFish"/>

  <Viewpoint
    DEF="SideView_MouthLeft"
    description="Side view (mouth left, tail right)"
    position="3 0.5 0"
    orientation="0 1 0 1.5708"
    fieldOfView="0.8"/>

</Scene>
</X3D>
